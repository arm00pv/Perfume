<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Perfume Identifier</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            background-color: #f0f0f0;
        }
        h1 {
            color: #333;
        }
        #container {
            position: relative;
            width: 640px;
            height: 480px;
            border: 2px solid black;
        }
        #video, #overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #overlay-canvas {
            cursor: pointer;
        }
        #results {
            width: 640px;
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 100px;
            background-color: white;
        }
    </style>
</head>
<body>
    <h1>Live Perfume Identifier</h1>
    <p>Point your camera at perfume bottles. Click a box for details.</p>
    <div id="container">
        <video id="video" autoplay playsinline></video>
        <canvas id="overlay-canvas"></canvas>
    </div>
    <div id="status">Live</div>
    <div id="results">
        <p>Click on a detected perfume to see its details here.</p>
    </div>

    <script>
        const video = document.getElementById('video');
        const overlayCanvas = document.getElementById('overlay-canvas');
        const overlayCtx = overlayCanvas.getContext('2d');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        let activeDetections = []; // Now stores only the raw predictions from /api/identify
        let isRequesting = false;
        const processInterval = 1000; // ms between requests

        async function startCamera() {
            try {
                const constraints = { video: { facingMode: 'environment' } };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.addEventListener('loadedmetadata', () => {
                    overlayCanvas.width = video.videoWidth;
                    overlayCanvas.height = video.videoHeight;
                    setInterval(processFrame, processInterval);
                });
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert("Could not access the camera. Please make sure you have a camera connected and have granted permission.");
            }
        }

        async function processFrame() {
            if (isRequesting || video.paused || video.ended) {
                return;
            }
            isRequesting = true;
            statusDiv.textContent = 'Analyzing...';

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
            const dataUrl = tempCanvas.toDataURL('image/jpeg');

            try {
                // Call the FAST endpoint
                const response = await fetch('https://perfume-dj64.onrender.com/api/identify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: dataUrl }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                handleDetections(data, dataUrl); // Pass dataUrl for the click handler

            } catch (error) {
                console.error('Error during detection:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                activeDetections = [];
                drawOverlays();
            } finally {
                isRequesting = false;
            }
        }

        function handleDetections(data, dataUrl) {
            statusDiv.textContent = 'Live';
            // Store raw predictions and the dataUrl of the frame they belong to
            activeDetections = (data.predictions || []).map(p => ({
                prediction: p,
                frameDataUrl: dataUrl
            }));
            drawOverlays();
        }

        function drawOverlays() {
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            activeDetections.forEach(det => {
                const p = det.prediction;
                const x = p.x - p.width / 2;
                const y = p.y - p.height / 2;
                overlayCtx.strokeStyle = '#FFD700'; // Default color is now Gold
                overlayCtx.fillStyle = overlayCtx.strokeStyle;
                overlayCtx.lineWidth = 4;
                overlayCtx.strokeRect(x, y, p.width, p.height);
                overlayCtx.font = '20px Arial';
                const label = `${p.class} (${(p.confidence * 100).toFixed(0)}%)`;
                overlayCtx.fillText(label, x, y > 30 ? y - 10 : y + p.height + 30);
            });
        }

        overlayCanvas.addEventListener('click', async (event) => {
            const rect = overlayCanvas.getBoundingClientRect();
            const scaleX = overlayCanvas.width / rect.width;
            const scaleY = overlayCanvas.height / rect.height;
            const clickX = (event.clientX - rect.left) * scaleX;
            const clickY = (event.clientY - rect.top) * scaleY;

            const clickedDetection = activeDetections.find(det => {
                const p = det.prediction;
                const boxX = p.x - p.width / 2;
                const boxY = p.y - p.height / 2;
                return clickX >= boxX && clickX <= boxX + p.width && clickY >= boxY && clickY <= boxY + p.height;
            });

            if (clickedDetection) {
                resultsDiv.innerHTML = `<p>Fetching details for ${clickedDetection.prediction.class}...</p>`;

                try {
                    // Call the NEW slow endpoint
                    const response = await fetch('https://perfume-dj64.onrender.com/api/get_details', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            perfume_name: clickedDetection.prediction.class,
                            bounding_box: clickedDetection.prediction,
                            image_data_url: clickedDetection.frameDataUrl // Send the original frame
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const details = await response.json();
                    displayDetails(details, clickedDetection.prediction.class);

                } catch (error) {
                    resultsDiv.innerHTML = `<p style="color:red;">Error fetching details: ${error.message}</p>`;
                }
            }
        });

        function displayDetails(details, perfumeName) {
            let html = `<h3>Details for ${perfumeName}</h3>`;

            if (details.fragrantica_url) {
                html += `<p><a href="${details.fragrantica_url}" target="_blank">View on Fragrantica</a></p>`;
            }

            html += `<strong>Verification:</strong> ${details.is_verified ? '<span style="color:green;">✅ Verified</span>' : '<span style="color:red;">❌ Unverified</span>'}<br>`;
            html += `<small><strong>OCR Text:</strong> <em>"${details.ocr_text}"</em></small>`;

            if (details.fragrance_profile && !details.fragrance_profile.error) {
                const profile = details.fragrance_profile;
                html += '<h4>Fragrance Profile:</h4>';
                for (const noteType in profile) {
                    html += `<h5>${noteType}</h5>`;
                    html += `<ul>${profile[noteType].map(note => `<li>${note}</li>`).join('')}</ul>`;
                }
            }

            resultsDiv.innerHTML = html;
        }

        startCamera();
    </script>
</body>
</html>
